<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.accountbook.dao.MessageDao" >
  <resultMap id="map" type="com.accountbook.model.Message" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="from_id" property="fromId" jdbcType="VARCHAR" />
    <result column="to_id" property="toId" jdbcType="VARCHAR" />
    <result column="type" property="type" jdbcType="TINYINT" />
    <result column="content" property="content" jdbcType="VARCHAR" />
    <result column="time" property="time" jdbcType="TIMESTAMP" />
    <result column="state" property="state" jdbcType="TINYINT" />
  </resultMap>
  
  <!-- 查询聊天列表:每个用户的最后一条消息 -->
  	<select id="queryChatList" parameterType="String" resultMap="map">
  		SELECT * FROM message WHERE id IN(
		SELECT MAX(id) FROM (
		(SELECT * FROM message WHERE  from_id=#{userId} AND TYPE=3 AND state!=2
		UNION
		SELECT * FROM message WHERE  to_id=#{userId} AND TYPE=3 AND state!=2)
		
		)AS b GROUP BY b.from_id,b.to_id
		)
		
		 UNION 
		 
		 SELECT * FROM ( 
		 SELECT * FROM message WHERE to_id=#{userId} AND (TYPE=1 OR TYPE=2)ORDER BY TIME DESC LIMIT 0,1) AS b
		 
		 ORDER BY TIME DESC
	</select>
  
  
  
	<select id="queryMsg" parameterType="long" resultMap="map">
		SELECT * FROM message WHERE id = #{id};
	</select>
	<select id="queryUserMsgs" parameterType="map" resultMap="map">
		SELECT * FROM 
		(SELECT * FROM message WHERE TYPE=3 AND state!=2 and
				((from_id=#{user1Id} AND to_id=#{user2Id}) OR
				(from_id=#{user2Id} AND to_id=#{user1Id})) ORDER BY TIME DESC LIMIT #{ls},#{lc})AS a
				ORDER BY TIME ASC
	</select>
	<select id="queryInviteMsgs" parameterType="map" resultMap="map">
		SELECT * FROM message WHERE to_id = #{userId} and state!=2 ORDER BY TIME DESC LIMIT #{ls},#{lc};
	</select>
	
	<select id="isRepeatInvite" parameterType="String" resultType="Boolean">
		SELECT count(*) FROM message WHERE from_id = #{0} and to_id = #{1} and state!=12;
	</select>
	
	<select id="queryAccountMsgs" parameterType="string" resultMap="map">
		 #查询账单相关的消息
		 SELECT * FROM message WHERE 
			content LIKE #{0} OR 
			content LIKE #{1} OR
			content LIKE #{2}
	</select>
	
	

	
	
	
	
	<select id="queryUserUnreadCount" parameterType="map" resultType="integer">
		SELECT count(*) FROM message WHERE (  (from_id=#{user1Id} and to_id=#{user2Id}) or (from_id=#{user2Id} and to_id=#{user1Id}) ) and state=0;
	</select>
	
	<select id="queryInviteUnreadCount" parameterType="String" resultType="integer">
		SELECT count(*) FROM message WHERE to_id = #{toId} and (type=1 or type=2) and state=0;
	</select>
	
	<!-- 插入 -->
	<insert id="insert" parameterType="com.accountbook.model.Message">
		insert into message values(null,#{fromId},#{toId},#{type},#{content},#{time},#{state})
	</insert>
	
	<!-- 更新 -->
	<update id="updateStatus" parameterType="long">
		update message set state=#{1} where id=#{0}
	</update>
	
	<!-- 和某个帐友的所有消息标记为某个状态 -->
	<update id="updateStatusBatch" parameterType="map">
		update message set state=#{state} WHERE (  (from_id=#{user1Id} and to_id=#{user2Id}) or (from_id=#{user2Id} and to_id=#{user1Id}) ) and state!=2;
	</update>
	
	
	<!-- 删除 -->
	<delete id="delete" parameterType="long">
		delete from message where id=#{id};
	</delete>
</mapper>