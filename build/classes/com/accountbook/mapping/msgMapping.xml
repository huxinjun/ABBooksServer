<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.accountbook.dao.MessageDao" >
  <resultMap id="map" type="com.accountbook.model.Message" >
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="from_id" property="fromId" jdbcType="VARCHAR" />
    <result column="to_id" property="toId" jdbcType="VARCHAR" />
    <result column="type" property="type" jdbcType="TINYINT" />
    <result column="content" property="content" jdbcType="VARCHAR" />
    <result column="time" property="time" jdbcType="TIMESTAMP" />
    <result column="state" property="state" jdbcType="TINYINT" />
  </resultMap>
  
  <!-- 查询聊天列表:每个用户的最后一条消息 -->
  	<select id="queryChatList" parameterType="String" resultMap="map">
  		SELECT * FROM (SELECT * FROM message WHERE (from_id IN
		(
		SELECT DISTINCT(from_id) FROM message WHERE from_id=#{userId} OR to_id=#{userId}
		) AND from_id!=#{userId} AND to_id=#{userId})
		OR (from_id IN
		(
		SELECT DISTINCT(to_id) FROM message WHERE from_id=#{userId} OR to_id=#{userId}
		) AND to_id!=#{userId} AND from_id=#{userId})
		
		
		 AND TYPE=3
		 ORDER BY TIME DESC LIMIT 0,1) AS a
		 
		UNION
		 
		 SELECT * FROM ( 
		 SELECT * FROM message WHERE to_id=#{userId} AND (TYPE=1 OR TYPE=2)ORDER BY TIME DESC LIMIT 0,1) AS b
		 
		 ORDER BY TIME DESC
	</select>
  
  
  
	<select id="queryMsg" parameterType="integer" resultMap="map">
		SELECT * FROM message WHERE id = #{id};
	</select>
	<select id="queryUserMsgs" parameterType="map" resultMap="map">
		SELECT * FROM 
		(SELECT * FROM message WHERE TYPE=3 AND
				((from_id=#{user1Id} AND to_id=#{user2Id}) OR
				(from_id=#{user2Id} AND to_id=#{user1Id})) ORDER BY TIME DESC LIMIT #{ls},#{lc})AS a
				ORDER BY TIME ASC
	</select>
	<select id="queryInviteMsgs" parameterType="String" resultMap="map">
		SELECT * FROM message WHERE to_id = #{userId} and state!=2;
	</select>
	
	

	
	
	
	
	<select id="queryUserUnreadCount" parameterType="map" resultType="integer">
		SELECT count(*) FROM message WHERE to_id = #{toId} and state=0;
	</select>
	
	<select id="queryInviteUnreadCount" parameterType="String" resultType="integer">
		SELECT count(*) FROM message WHERE to_id = #{toId} and (type=1 or type=2) and state=0;
	</select>
	
	<!-- 插入 -->
	<insert id="insert" parameterType="com.accountbook.model.Message">
		insert into message values(null,#{fromId},#{toId},#{type},#{content},#{time},#{state})
	</insert>
	
	<!-- 更新 -->
	<update id="updateStatus" parameterType="java.lang.Integer">
		update message set state=#{1} where id=#{0}
	</update>
</mapper>