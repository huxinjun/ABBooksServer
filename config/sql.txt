#自己加入或创建的组
SELECT group_id FROM group_user WHERE user_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' UNION #查询加入的组
SELECT id FROM group_ WHERE admin_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' #查询自己为管理员的组

#和自己相关的账单
SELECT account_id FROM account_member WHERE member_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' OR 
member_id IN (SELECT group_id FROM group_user WHERE user_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' UNION 
SELECT id FROM group_ WHERE admin_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ')

#和自己相关的分组
CREATE OR REPLACE VIEW `temp_me_account` AS
SELECT DISTINCT account_id FROM account_member WHERE member_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' OR 
member_id IN (SELECT group_id FROM group_user WHERE user_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' UNION 
SELECT id FROM group_ WHERE admin_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ');
#查询自己创建的组和账单中与自己相关的组的简要信息
SELECT id,NAME,icon,TRUE is_group FROM group_ WHERE admin_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' OR id IN (SELECT member_id FROM account_member WHERE is_group=TRUE AND account_id IN (SELECT account_id FROM temp_me_account))

#---------------------------------------------------------------------------------
#查询自己的帐友id
SELECT accept_id AS id FROM friend WHERE invite_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ'
UNION
SELECT invite_id AS id FROM friend WHERE accept_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ'

#查询自己的帐友简要信息
SELECT id,nickname AS NAME,icon,FALSE is_group FROM USER WHERE id IN(
SELECT accept_id AS id FROM friend WHERE invite_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ'
UNION
SELECT invite_id AS id FROM friend WHERE accept_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ')
#---------------------------------------------------------------------------------



#查询所有和我有关系的组和用户,记账时可选的成员
CREATE OR REPLACE VIEW temp_me_account AS
SELECT DISTINCT account_id FROM account_member WHERE member_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' OR 
member_id IN (SELECT group_id FROM group_user WHERE user_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' UNION 
SELECT id FROM group_ WHERE admin_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ');
#查询自己创建的组和账单中与自己相关的组
SELECT id,NAME,icon,TRUE is_group FROM group_ WHERE admin_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' OR id IN (SELECT member_id FROM account_member WHERE is_group=TRUE AND account_id IN (SELECT account_id FROM temp_me_account))
UNION
SELECT id,nickname AS NAME,icon,FALSE is_group FROM USER WHERE id IN(
SELECT accept_id AS id FROM friend WHERE invite_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ'
UNION
SELECT invite_id AS id FROM friend WHERE accept_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ')

#不使用视图
#查询自己创建的组和账单中与自己相关的组
SELECT id,NAME,icon,TRUE is_group FROM group_ WHERE admin_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' OR 
id IN (
SELECT member_id FROM account_member WHERE is_group=TRUE AND account_id IN (
SELECT account_id FROM account_member WHERE member_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' OR 
member_id IN (SELECT group_id FROM group_user WHERE user_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' UNION 
SELECT id FROM group_ WHERE admin_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ')))
UNION
#查询所有帐友
SELECT id,nickname AS NAME,icon,FALSE is_group FROM USER WHERE id IN(
SELECT accept_id AS id FROM friend WHERE invite_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ'
UNION
SELECT invite_id AS id FROM friend WHERE accept_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ')
#查询所有待完善的账单个数
SELECT 'wait_edit' NAME,COUNT(*) AS number FROM account_pay AS a LEFT JOIN account AS b ON a.account_id=b.id 
WHERE (a.paid_id IN (SELECT group_id FROM group_user WHERE user_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ') AND a.paid_status=1)
OR
(a.receipt_id IN (SELECT group_id FROM group_user WHERE user_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ') AND a.receipt_status=1)




查询加入的组或者创建的组
SELECT * FROM group_ AS g LEFT JOIN group_user AS u ON g.id=u.group_id  WHERE admin_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' OR user_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' ORDER BY CONVERT(category USING gbk),CONVERT(NAME USING gbk)

















#-------------------------------------------------------------------------------------------------------------

#查询当月总支出(自己)
SELECT 'month_paidin' NAME,SUM(money) AS money FROM (
SELECT SUM(paid_in) AS money FROM account WHERE is_private=1 AND user_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' AND DATE_FORMAT(NOW(),'%Y-%m')=DATE_FORMAT(date_timestamp,'%Y-%m')
UNION
SELECT SUM(a.should_pay) AS money FROM account_member AS a LEFT JOIN account AS b ON  a.account_id=b.id WHERE member_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' AND DATE_FORMAT(NOW(),'%Y-%m')=DATE_FORMAT(b.date_timestamp,'%Y-%m'))AS total

UNION

#查询全部待付款(自己)
SELECT 'wait_paid' NAME,SUM(wait_paid_money) FROM account_pay AS a LEFT JOIN account AS b ON a.account_id=b.id WHERE a.wait_paid_money>0 AND a.paid_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ'

UNION

#查询全部待收款(自己)
SELECT 'wait_receipt' NAME,SUM(wait_paid_money) FROM account_pay AS a LEFT JOIN account AS b ON a.account_id=b.id WHERE a.wait_paid_money>0 AND a.receipt_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ'
#-------------------------------------------------------------------------------------------------------------




#查询所有待付款(指定另一个人)
SELECT 'wait_paid' NAME,p.number-r.number AS number FROM(SELECT 0 id, IFNULL(SUM(wait_paid_money),0) AS number FROM account_pay AS a
WHERE wait_paid_money>0 AND id!='7ncUUBN7AdCEsXuBP6MHqQ==' AND a.paid_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' AND a.receipt_id='oCBrx0FreB-L8pIQM5_RYDGoWOJJ') p LEFT JOIN 
(SELECT 0 id,IFNULL(SUM(wait_paid_money),0) AS number FROM account_pay AS a 
WHERE wait_paid_money>0 AND id!='7ncUUBN7AdCEsXuBP6MHqQ==' AND a.paid_id='oCBrx0FreB-L8pIQM5_RYDGoWOJJ' AND a.receipt_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ') r ON p.id=r.id

		
UNION		
		
		
#查询两个人的月支出(自己和一个朋友)
SELECT 'month_paidin' NAME,SUM(should_pay) AS number FROM account_member WHERE account_id IN
(
SELECT a.id FROM account AS a LEFT JOIN account_member AS am ON a.id=am.account_id WHERE a.id IN(
SELECT a.id FROM account AS a LEFT JOIN account_member AS am ON a.id=am.account_id WHERE member_id ='oCBrx0FreB-L8pIQM5_RYDGoWOKQ'
) AND member_id='oCBrx0FreB-L8pIQM5_RYDGoWOJJ' AND DATE_FORMAT(NOW(),'%Y-%m')=DATE_FORMAT(a.date_timestamp,'%Y-%m')
)
AND member_id IN('oCBrx0FreB-L8pIQM5_RYDGoWOKQ','oCBrx0FreB-L8pIQM5_RYDGoWOJJ')

UNION

#查询两个人的总支出(自己和一个朋友)
SELECT 'paidin' NAME,SUM(should_pay) AS number FROM account_member WHERE account_id IN
(
SELECT a.id FROM account AS a LEFT JOIN account_member AS am ON a.id=am.account_id WHERE a.id IN(
SELECT a.id FROM account AS a LEFT JOIN account_member AS am ON a.id=am.account_id WHERE member_id ='oCBrx0FreB-L8pIQM5_RYDGoWOKQ'
) AND member_id='oCBrx0FreB-L8pIQM5_RYDGoWOJJ' 
)
AND member_id IN('oCBrx0FreB-L8pIQM5_RYDGoWOKQ','oCBrx0FreB-L8pIQM5_RYDGoWOJJ')















#查询最初始的一个待付大于0的PayTarget
SELECT * FROM account_pay AS p LEFT JOIN account AS a ON p.account_id=a.id
WHERE wait_paid_money>0 AND p.paid_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' AND p.receipt_id='oCBrx0FreB-L8pIQM5_RYDGoWOJJ' ORDER BY a.`date_timestamp` ASC LIMIT 0,1

#-------------------------------------------------------------------------------------------------------------

#查询自己记录或者涉及到自己的账单(所有账本)
SELECT * FROM account WHERE 
id IN(SELECT DISTINCT account_id FROM account_member WHERE member_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ') 
OR user_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ'


#查询自己记录或者涉及到自己的账单(某个账本)
SELECT * FROM account WHERE book_id='' AND (
id IN(SELECT DISTINCT account_id FROM account_member WHERE member_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ') 
OR user_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' )


#查询两个人参与的账单
SELECT * FROM account AS a LEFT JOIN account_member AS am ON a.id=am.account_id WHERE a.id IN(
SELECT a.id FROM account AS a LEFT JOIN account_member AS am ON a.id=am.account_id WHERE member_id ='oCBrx0FreB-L8pIQM5_RYDGoWOKQ'
) AND member_id='oCBrx0FreB-L8pIQM5_RYDGoWOJJ' ORDER BY date_timestamp DESC,create_timestamp DESC













#-------------------------------------------------------------------------------------------------------------
#查询聊天信息,最近的10条
SELECT * FROM 
(SELECT * FROM message WHERE TYPE=3 AND
		((from_id='oCBrx0FreB-L8pIQM5_RYDGoWOJJ' AND to_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ') OR
		(from_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' AND to_id='oCBrx0FreB-L8pIQM5_RYDGoWOJJ')) ORDER BY TIME DESC LIMIT 0,10)AS a
		ORDER BY TIME ASC



#查询聊天列表(最后一条消息)
SELECT * FROM (SELECT * FROM message WHERE (from_id IN
(
SELECT DISTINCT(from_id) FROM message WHERE from_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' OR to_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ'
) AND from_id!='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' AND to_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ')
OR (from_id IN
(
SELECT DISTINCT(to_id) FROM message WHERE from_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' OR to_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ'
) AND to_id!='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' AND from_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ')


 AND TYPE=3
 ORDER BY TIME DESC LIMIT 0,1) AS a
 
UNION
 
 SELECT * FROM ( 
 SELECT * FROM message WHERE to_id='oCBrx0FreB-L8pIQM5_RYDGoWOKQ' AND (TYPE=1 OR TYPE=2)ORDER BY TIME DESC LIMIT 0,1) AS b
 
 ORDER BY TIME DESC
 
 
 
 
 
 
 
 
 
 
 
 
 
 
#-------------------------------------------------------------------------------------------------------------
#查询抵消记录列表
SELECT c.type,c.name,c.paid_in,c.date_timestamp,d.icon AS paid_icon,e.icon AS receipt_icon,b.money FROM account_pay_offset AS a 
LEFT JOIN account_pay AS b ON a.origin_pay_id=b.id 
LEFT JOIN account AS c ON b.account_id=c.id
LEFT JOIN USER AS d ON b.paid_id=d.id
LEFT JOIN USER AS e ON b.receipt_id=e.id
WHERE target_pay_id='lxRSsgKmM6aKyxjSoyewzA==' 
